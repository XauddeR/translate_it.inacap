{% extends "base.html" %}
{% from "_forms.html" import csrf %}
{% block title %}Soporte · Translate It{% endblock %}

{% block content %}
<section class="relative">
  <div class="absolute inset-0 -z-10">
    <div class="absolute -bottom-32 left-1/2 -translate-x-1/2 w-[1200px] h-[1200px] rounded-full blur-3xl opacity-30"
         style="background: radial-gradient(closest-side, rgba(59,130,246,.35), rgba(29,78,216,.25), transparent 70%);"></div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10 md:py-14">
    <div class="flex items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Centro de Soporte</h1>
        <p class="mt-1 text-slate-300">FAQ, tickets y seguimiento de tus solicitudes al soporte.</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[260px,1fr] gap-6">
      <aside class="md:sticky md:top-24 md:self-start rounded-2xl bg-white/5 ring-1 ring-white/10 p-4 md:p-5 md:block">
        <nav>
          <ul class="space-y-1 text-sm">
            <li>
              <a href="{{ url_for('main.dashboard') }}"
                 class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 hover:ring-1 hover:ring-white/10 text-slate-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="1.7" d="M3.5 6.5h17M3.5 12h17M3.5 17.5h17"/></svg>
                Dashboard
              </a>
            </li>
            <li>
              <a href="{{ url_for('upload.upload_file') }}"
                 class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 hover:ring-1 hover:ring-white/10 text-slate-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="1.7" d="M12 4v16m8-8H4"/></svg>
                Subir Video
              </a>
            </li>
            <li>
              <a href="{{ url_for('main.history') }}"
                 class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-white/5 hover:ring-1 hover:ring-white/10 text-slate-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="1.7" d="M3 12a9 9 0 0118 0A9 9 0 013 12zm9-7v4l2 2"/></svg>
                Historial
              </a>
            </li>
            <li>
              <a href="{{ url_for('support.support_home') }}"
                 class="flex items-center gap-3 px-3 py-2 rounded-lg bg-brand-600/20 text-brand-200 ring-1 ring-brand-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="1.7" d="M9.88 7.52c1.17-1.02 3.07-1.02 4.24 0 1.17 1.02 1.17 2.69 0 3.71-.2.18-.43.33-.67.44-.75.36-1.45 1-1.45 1.83v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"/></svg>
                Soporte
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <div id="sidebarSheet" class="fixed inset-0 z-40 hidden md:hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur"></div>
        <aside class="absolute right-0 top-0 h-full w-80 max-w-[80%] bg-slate-950 border-l border-white/10 p-5">
          <div class="flex items-center justify-between">
            <span class="font-semibold">Menú</span>
            <button id="closeSidebar" class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-white/5 ring-1 ring-white/10 hover:bg-white/10">✕</button>
          </div>
          <nav class="mt-4">
            <ul class="space-y-1 text-base">
              <li><a href="{{ url_for('main.dashboard') }}" class="block px-3 py-2 rounded-lg hover:bg-white/5 hover:ring-1 hover:ring-white/10 text-slate-300">Dashboard</a></li>
              <li><a href="#" class="block px-3 py-2 rounded-lg hover:bg-white/5 hover:ring-1 hover:ring-white/10 text-slate-300">Mi Perfil</a></li>
              <li><a href="{{ url_for('support.support_home') }}" class="block px-3 py-2 rounded-lg bg-brand-600/20 text-brand-200 ring-1 ring-brand-500/30">Soporte</a></li>
            </ul>
          </nav>
        </aside>
      </div>

      <main>
      {% with messages = get_flashed_messages(with_categories=true, category_filter=['ticket_error', 'ticket_success']) %}
        {% if messages %}
          <div class="containerFlashMessage mb-4 space-y-2">
            {% for category, message in messages %}
              <div class="rounded-xl px-4 py-3 text-sm
                          {% if category == 'ticket_error' %} bg-rose-900/30 text-rose-200 ring-1 ring-rose-500/30
                          {% elif category == 'ticket_success' %} bg-emerald-900/30 text-emerald-200 ring-1 ring-emerald-500/30
                          {% else %} bg-white/5 text-slate-200 ring-1 ring-white/10 {% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
          <div class="lg:col-span-2 rounded-2xl bg-white/5 ring-1 ring-white/10 p-8">
            <h2 class="text-2xl font-semibold mb-6">Preguntas frecuentes (FAQ)</h2>
            <div class="space-y-4">
              <details class="group rounded-xl bg-white/5 ring-1 ring-white/10 p-5">
                <summary class="cursor-pointer flex justify-between items-center font-semibold text-slate-200">
                  ¿Qué formatos de video son compatibles?
                  <span class="transition group-open:rotate-45 text-slate-400">+</span>
                </summary>
                <p class="mt-3 text-sm text-slate-300 leading-relaxed">
                  Aceptamos <strong>MP4, MOV, MKV y AVI</strong>. Si tu formato es distinto, conviértelo a MP4 antes de subirlo.
                </p>
              </details>

              <details class="group rounded-xl bg-white/5 ring-1 ring-white/10 p-5">
                <summary class="cursor-pointer flex justify-between items-center font-semibold text-slate-200">
                  ¿Qué tan precisas son las traducciones?
                  <span class="transition group-open:rotate-45 text-slate-400">+</span>
                </summary>
                <p class="mt-3 text-sm text-slate-300 leading-relaxed">
                  Usamos <strong>Whisper</strong> para transcripción y <strong>DeepL</strong> para traducción. Ambos con precisión profesional.
                </p>
              </details>

              <details class="group rounded-xl bg-white/5 ring-1 ring-white/10 p-5">
                <summary class="cursor-pointer flex justify-between items-center font-semibold text-slate-200">
                  ¿Puedo editar el nombre de mi archivo?
                  <span class="transition group-open:rotate-45 text-slate-400">+</span>
                </summary>
                <p class="mt-3 text-sm text-slate-300 leading-relaxed">
                  Sí. En tu <b>Historial</b> puedes renombrar cualquier archivo a través del botón de edición en cualquier video de tu historial.
                </p>
              </details>
            </div>
          </div>

          <div class="lg:col-span-1 rounded-2xl bg-white/5 ring-1 ring-white/10 p-8">
            <h2 class="text-2xl font-semibold mb-6">¿Aún tienes dudas?</h2>
            <p class="text-sm text-slate-300 mb-6">
              Envía un mensaje y nuestro equipo te responderá lo antes posible.
            </p>

            <form action="{{ url_for('support.create_ticket') }}" method="POST" class="space-y-5">
              {{ csrf() }}
              <div>
                <label for="subject" class="block text-sm font-medium text-slate-200 mb-1">Asunto</label>
                <input type="text" id="subject" name="subject" required maxlength="150"
                       class="w-full rounded-lg bg-slate-900/60 border border-white/10 px-4 py-2.5 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500" />
              </div>

              <div>
                <label for="message" class="block text-sm font-medium text-slate-200 mb-1">Mensaje</label>
                <textarea id="message" name="message" rows="6" required
                          class="w-full rounded-lg bg-slate-900/60 border border-white/10 px-4 py-2.5 text-slate-100 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 resize-none"></textarea>
              </div>

              <button type="submit"
                      class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-brand-600 hover:bg-brand-500 text-white font-semibold py-2.5 shadow-glow">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 -ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L5.999 12zm0 0h7.5" />
                </svg>
                Enviar Mensaje
              </button>
            </form>
          </div>
        </div>

        {% if tickets and tickets|length > 0 %}
          {% set estado_clases = {
            'abierto': 'bg-brand-900/30 text-brand-200 ring-1 ring-brand-500/30',
            'pendiente': 'bg-amber-900/30 text-amber-200 ring-1 ring-amber-500/30',
            'resuelto': 'bg-emerald-900/30 text-emerald-200 ring-1 ring-emerald-500/30',
            'cerrado': 'bg-slate-800 text-slate-400 ring-1 ring-white/10'
          } %}
          <section class="mt-10">
            <div class="rounded-2xl bg-white/5 ring-1 ring-white/10 p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Mis tickets</h2>
                <a href="{{ url_for('support.support_home') }}" class="text-sm text-slate-400 hover:text-white">Actualizar</a>
              </div>

              <div class="space-y-3">
                {% for t in tickets %}
                <a href="{{ url_for('support.view_ticket', ticket_id=t.id) }}"
                   class="block rounded-xl bg-white/5 ring-1 ring-white/10 hover:bg-white/10 transition p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0">
                      <div class="font-medium text-slate-100 truncate">{{ t.asunto }}</div>
                      <div class="text-xs text-slate-400 mt-1">
                        {% if t.actualizado_en %}
                          Actualizado: {{ t.actualizado_en }}
                        {% else %}
                          Creado: {{ t.creado_en }}
                        {% endif %}
                      </div>
                    </div>
                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium {{ estado_clases.get(t['estado']|lower, 'bg-slate-800 text-slate-400 ring-1 ring-white/10') }}">
                      {{ t.estado|capitalize }}
                    </span>
                  </div>
                </a>
                {% endfor %}
              </div>
            </div>
          </section>
        {% endif %}
      </main>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  document.querySelectorAll('details').forEach(el => {
    el.addEventListener('toggle', e => {
      const icon = e.target.querySelector('summary span');
      if (icon) icon.classList.toggle('rotate-45', e.target.open);
    });
  });
</script>
{% endblock %}
