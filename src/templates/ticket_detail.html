<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .flash-fade-out {
      opacity: 0;
      transition: opacity 0.5s ease-out;
    }
  </style>
  <title>Ticket #{{ ticket.id }} - {{ ticket.asunto }}</title>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen font-sans antialiased flex flex-col">

  <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex items-center justify-between py-5 px-6">
      <h1 class="text-3xl font-extrabold text-blue-600 tracking-tight">
        <a href="{{ url_for('main.index') }}">Translate It</a>
      </h1>
      <nav class="space-x-6 text-sm font-medium flex items-center">
        <a href="{{ url_for('main.index') }}" class="text-slate-600 hover:text-blue-600 transition">INICIO</a>
        <a href="{{ url_for('main.dashboard') }}" class="text-slate-600 hover:text-blue-600 transition">PANEL DE USUARIO</a>
        <a href="{{ url_for('auth.logout') }}" class="text-red-500 hover:text-red-600 font-medium">CERRAR SESIÓN</a>
      </nav>
    </div>
  </header>

  <div class="flex flex-1">
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
      <nav class="flex-1 px-4 py-6">
        <ul class="space-y-2 text-sm">
          <li>
            <a href="{{ url_for('main.dashboard') }}"
               class="flex items-center space-x-3 py-2 px-3 rounded-md transition text-slate-600 hover:bg-blue-50 hover:text-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h12A2.25 2.25 0 0120.25 6v12A2.25 2.25 0 0118 20.25H6A2.25 2.25 0 013.75 18V6zM3.75 12H6m1.5 0h.008m.007 0H9m.75 0h.008m.007 0h.75m3 0h.008m.007 0h.75m1.5 0h.008m.007 0H18m-9 3.75h.008m.007 0h.75m1.5 0h.008m.007 0h.75m-3-7.5h.008m.007 0h.75m1.5 0h.008m.007 0h.75" />
              </svg>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a href="#" class="flex items-center space-x-3 py-2 px-3 rounded-md transition text-slate-600 hover:bg-blue-50 hover:text-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
              </svg>
              <span>Mi Perfil</span>
            </a>
          </li>
          <li>
            <a href="{{ url_for('support.support_home') }}"
               class="flex items-center space-x-3 py-2 px-3 rounded-md transition font-semibold bg-blue-50 text-blue-700">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
              </svg>
              <span>Soporte</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main id="mainContent" class="flex-1 p-10 bg-slate-50">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-6 space-y-2" id="flash-container">
            {% for category, message in messages %}
              <div
                class="js-flash px-4 py-3 rounded-lg border transition-opacity duration-300
                       {% if category in ['error','danger'] %}bg-red-50 border-red-200 text-red-700
                       {% elif category == 'success' %}bg-green-50 border-green-200 text-green-700
                       {% else %}bg-slate-50 border-slate-200 text-slate-700{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      {% set estado_clases = {
        'abierto':   'bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-200',
        'pendiente': 'bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-200',
        'resuelto':  'bg-emerald-50 text-emerald-700 ring-1 ring-inset ring-emerald-200',
        'cerrado':   'bg-slate-100 text-slate-600 ring-1 ring-inset ring-slate-200'
      } %}

      <div class="mb-8">
        <a href="{{ url_for('support.support_home') }}" class="text-sm text-blue-600 hover:text-blue-700 mb-4 inline-block">&larr; Volver a Soporte</a>
        <h1 class="text-4xl font-extrabold text-slate-900">{{ ticket.asunto }}</h1>
        <div class="mt-3 flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-slate-600">
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium {{ estado_clases.get(ticket.estado|lower, 'bg-slate-100 text-slate-600 ring-1 ring-inset ring-slate-200') }}">
            {{ ticket.estado|capitalize }}
          </span>
          {% if ticket.actualizado_en %}
            <span>Actualizado: {{ ticket.actualizado_en }}</span>
          {% endif %}
          <span class="text-slate-400">•</span>
          <span class="font-mono text-xs">Ticket #{{ ticket.id }}</span>
        </div>
      </div>

      <section class="bg-white border border-slate-200 rounded-xl shadow-lg p-6">
        <h2 class="sr-only">Conversación</h2>
        <div class="space-y-6">
          {% if mensajes and mensajes|length > 0 %}
            {% for m in mensajes %}
              {% set es_usuario = m.autor_usuario_id is not none %}
              <div class="flex {{ 'justify-end' if es_usuario else 'justify-start' }}">
                <div class="max-w-[85%]">
                  <div class="flex items-center gap-2 text-xs mb-1.5 {{ 'justify-end' if es_usuario else 'justify-start' }}">
                    {% if es_usuario %}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-slate-400">
                        <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 00-13.074.003z" />
                      </svg>
                      <span class="font-medium text-slate-600">Tú</span>
                    {% else %}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-slate-400">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-2 0c0 .993-.241 1.929-.668 2.754l-1.524-1.525a3.997 3.997 0 00-.078-2.183l1.562-1.562C15.802 8.249 16 9.1 16 10zm-5.165 3.913l1.58 1.58A5.96 5.96 0 0110 16a5.96 5.96 0 01-2.415-.507l1.58-1.58a4 4 0 002.83 0zM10 4a5.96 5.96 0 012.415.507l-1.58 1.58a4 4 0 00-2.83 0L6.085 4.507A5.96 5.96 0 0110 4zM4 10c0-.9.198-1.751.535-2.546l1.562 1.562a3.997 3.997 0 00-.078 2.183l-1.524 1.525C4.24 11.929 4 10.993 4 10z" clip-rule="evenodd" />
                      </svg>
                      <span class="font-medium text-slate-600">Soporte</span>
                    {% endif %}
                    <span class="text-slate-400">• {{ m.creado_en }}</span>
                  </div>
                  <div class="whitespace-pre-wrap rounded-xl text-sm px-4 py-3 border
                              {{ 'bg-blue-50 border-blue-200 text-slate-800' if es_usuario else 'bg-slate-50 border-slate-200 text-slate-800' }}">
                    {{ m.mensaje }}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-sm text-center text-slate-500 py-4">Aún no hay mensajes en este ticket.</p>
          {% endif %}
        </div>
      </section>

      {% if ticket.estado not in ['resuelto', 'cerrado'] %}
        <section class="mt-6 bg-white border border-slate-200 rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-semibold text-slate-900 mb-4">Responder</h3>
          <form action="{{ url_for('support.reply_ticket', ticket_id=ticket.id) }}" method="POST" class="space-y-4" id="replyForm">
            <div>
              <label for="message" class="sr-only">Tu mensaje</label>
              <textarea id="message" name="message" rows="5" required
                        placeholder="Escribe tu respuesta aquí..."
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y text-sm"></textarea>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-xs text-slate-500">Recibirás la respuesta aquí mismo.</div>
              <button id="replyBtn" type="submit"
                      class="inline-flex items-center justify-center gap-2 px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 transition duration-150
                             focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                             disabled:opacity-60 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 -ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L5.999 12zm0 0h7.5" />
                </svg>
                <span id="replyBtnText">Enviar</span>
              </button>
            </div>
          </form>
        </section>
      {% else %}
        <section class="mt-6 bg-white border border-slate-200 rounded-xl shadow-lg p-6">
          <div class="flex items-center gap-3 bg-emerald-50 border border-emerald-200 text-emerald-800 rounded-lg p-4">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 flex-shrink-0">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
            </svg>
            <p class="text-sm">
              Este ticket está <strong>{{ ticket.estado }}</strong>. Si necesitas ayuda adicional, por favor
              <a href="{{ url_for('support.support_home') }}" class="font-medium hover:underline">crea un nuevo ticket</a>.
            </p>
          </div>
        </section>
      {% endif %}
    </main>
  </div>

  <footer class="bg-slate-100 border-t border-slate-200 py-8 mt-auto">
    <div class="max-w-7xl mx-auto text-center">
      <p class="text-sm text-slate-500">&copy; 2025 Translate It. Todos los derechos reservados.</p>
    </div>
  </footer>

  <script>
    // Script para auto-cerrar mensajes flash
    (function () {
      const flashes = document.querySelectorAll('.js-flash');
      if (!flashes.length) return;
      setTimeout(() => {
        flashes.forEach(el => {
          el.classList.add('flash-fade-out'); // Usa la clase CSS para la transición
          setTimeout(() => el.remove(), 500); // Coincide con la duración de la transición
        });
      }, 5000); // 5 segundos
    })();

    // Estado "Enviando..." en el botón de respuesta
    (function () {
      const form = document.getElementById('replyForm');
      const btn  = document.getElementById('replyBtn');
      const btnText = document.getElementById('replyBtnText');
      if (!form || !btn || !btnText) return;
      form.addEventListener('submit', () => {
        btn.disabled = true;
        btnText.textContent = 'Enviando…'; // Cambia solo el texto
      });
    })();
  </script>

</body>
</html>
